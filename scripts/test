#!/usr/bin/env bash
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Configurable packages - modify this variable when extracting info package
PACKAGES="${PACKAGES:-treex}"

# Use PROJECT_ROOT from environment or calculate it
if [ -z "${PROJECT_ROOT:-}" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
fi

cd "$PROJECT_ROOT"

echo -e "${BLUE}${BOLD}Running tests for packages: ${PACKAGES}...${NC}"
echo

# Check if gotestsum is available for better output
if command -v gotestsum &> /dev/null; then
    echo -e "${BLUE}Using gotestsum for enhanced test output${NC}"
    TEST_CMD="gotestsum --format testname --"
else
    echo -e "${YELLOW}Consider installing gotestsum for better test output:${NC}"
    echo -e "${YELLOW}  go install gotest.tools/gotestsum@latest${NC}"
    echo
    TEST_CMD="go test"
fi

# Build test patterns for configured packages
TEST_PATTERNS=""
for PACKAGE in $PACKAGES; do
    if [[ "$PACKAGE" == "treex" ]]; then
        TEST_PATTERNS="$TEST_PATTERNS ./treex/..."
    elif [[ "$PACKAGE" == "infofile" ]]; then
        TEST_PATTERNS="$TEST_PATTERNS ./infofile/..."
    fi
done

# Add cmd and root level if treex is included
if [[ "$PACKAGES" == *"treex"* ]]; then
    TEST_PATTERNS="$TEST_PATTERNS ./cmd/..."
fi

# Run tests with coverage
echo -e "${BLUE}Running tests with coverage...${NC}"
if $TEST_CMD -coverprofile=coverage.out -covermode=atomic $TEST_PATTERNS; then
    echo -e "${GREEN}✓ All tests passed${NC}"
    
    # Show coverage summary
    echo
    echo -e "${BLUE}Coverage summary:${NC}"
    go tool cover -func=coverage.out | tail -n 1
    
    # Generate HTML coverage report if requested
    if [[ "${COVERAGE_HTML:-}" == "true" ]]; then
        echo
        echo -e "${BLUE}Generating HTML coverage report...${NC}"
        go tool cover -html=coverage.out -o coverage.html
        echo -e "${GREEN}✓ Coverage report generated: coverage.html${NC}"
    fi
else
    echo -e "${RED}∅ Tests failed${NC}"
    exit 1
fi

echo
echo -e "${GREEN}${BOLD}All tests completed successfully!${NC}"